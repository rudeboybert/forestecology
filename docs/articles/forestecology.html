<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The `forestecology` R package for fitting and assessing neighborhood models of the effect of interspecific competition on the growth of trees • forestecology</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="The `forestecology` R package for fitting and assessing neighborhood models of the effect of interspecific competition on the growth of trees">
<meta property="og:description" content="forestecology">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">forestecology</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/forestecology.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rudeboybert/forestecology/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="forestecology_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>The <code>forestecology</code> R package for fitting and assessing neighborhood models of the effect of interspecific competition on the growth of trees</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rudeboybert/forestecology/blob/master/vignettes/forestecology.Rmd"><code>vignettes/forestecology.Rmd</code></a></small>
      <div class="hidden name"><code>forestecology.Rmd</code></div>

    </div>

    
    
<div id="purpose" class="section level1">
<h1 class="hasAnchor">
<a href="#purpose" class="anchor"></a>Purpose</h1>
<p>This package is designed to work for spatially mapped, repeat censused forests plots. The package has commands to fit models of tree growth based on neighborhood competition which can be used to estimate species-specific competition coefficients. The model fits can then be evaluated using a spatial cross-validation scheme to detect possible overfitting. Additionally, these models can test whether the species identity of competitors matters using a permutation test-style shuffling of competitor identity (under the null hypothesis) and subsequently evaluating if model performance changes. See Allen and Kim (2020) <a href="https://doi.org/10.1371/journal.pone.0229930">A permutation test and spatial cross-validation approach to assess models of interspecific competition between trees</a> for a full description.</p>
</div>
<div id="example-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#example-analysis" class="anchor"></a>Example analysis</h1>
<p>We present an example analysis using toy data pre-loaded into the package where we will:</p>
<ol style="list-style-type: decimal">
<li>Compute growth of trees based on census data</li>
<li>Add spatial information</li>
<li>Identify all focal and corresponding competitor trees</li>
<li>Fit model and make predictions</li>
<li>Run spatial cross-validation</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rudeboybert/forestecology">forestecology</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rvalavi/blockCV">blockCV</a></span><span class="op">)</span>

<span class="co"># Resolve conflicting functions</span>
<span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span></code></pre></div>
<div id="compute-growth-of-trees-based-on-census-data" class="section level2">
<h2 class="hasAnchor">
<a href="#compute-growth-of-trees-based-on-census-data" class="anchor"></a>Compute growth of trees based on census data</h2>
<p>The starting point of our analysis are data from two repeat censuses <code>census_1_ex</code> and <code>census_2_ex</code>. For example, consider the forest census data in <code>census_1_ex</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">census_1_ex</span>
<span class="co">#&gt; # A tibble: 10 × 7</span>
<span class="co">#&gt;       ID sp                gx    gy date       codes   dbh</span>
<span class="co">#&gt;    &lt;int&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1     1 sugar maple     0.75  2.5  2015-06-01 M         5</span>
<span class="co">#&gt;  2     2 American beech  1.5   2.5  2015-06-01 M        20</span>
<span class="co">#&gt;  3     3 sugar maple     1.75  2.25 2015-06-01 M        15</span>
<span class="co">#&gt;  4     4 American beech  3     1.5  2015-06-01 M        12</span>
<span class="co">#&gt;  5     5 sugar maple     3.25  1.75 2015-06-01 M        35</span>
<span class="co">#&gt;  6     6 American beech  5.5   4.5  2015-06-01 M         6</span>
<span class="co">#&gt;  7     7 sugar maple     8     1.5  2015-06-01 M        22</span>
<span class="co">#&gt;  8     8 American beech  8.5   0.75 2015-06-01 M        14</span>
<span class="co">#&gt;  9     9 sugar maple     8.75  1.5  2015-06-01 M        42</span>
<span class="co">#&gt; 10    10 American beech  8.75  1.75 2015-06-01 M         4</span></code></pre></div>
<p>We convert the <code>census_1_ex</code> data frame to an object of type <code>sf</code> and then plot using <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">census_1_ex</span> <span class="op">%&gt;%</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gx"</span>, <span class="st">"gy"</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">sp</span>, size <span class="op">=</span> <span class="va">dbh</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p><img src="man/figures/README-unnamed-chunk-3-1.png" width="100%"></p>
<p>We first combine data from two repeat censuses into a single <code>growth</code> data frame that has the average annual growth of all trees alive at both censuses that aren’t resprouts at the second census per Allen and Kim (2020).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">growth_ex</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/compute_growth.html">compute_growth</a></span><span class="op">(</span>
    census_1 <span class="op">=</span> <span class="va">census_1_ex</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/snakecase/man/to_any_case.html">to_any_case</a></span><span class="op">(</span><span class="va">sp</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
    census_2 <span class="op">=</span> <span class="va">census_2_ex</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">codes</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/snakecase/man/to_any_case.html">to_any_case</a></span><span class="op">(</span><span class="va">sp</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
    id <span class="op">=</span> <span class="st">"ID"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># Compute basal area:</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>basal_area <span class="op">=</span> <span class="fl">0.0001</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="va">dbh1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
</div>
<div id="add-spatial-information" class="section level2">
<h2 class="hasAnchor">
<a href="#add-spatial-information" class="anchor"></a>Add spatial information</h2>
<p>Our growth model assumes that two individual trees compete if they are less than a pre-specified distance <code>comp_dist</code> apart. Furthermore, we define a buffer region of size <code>comp_dist</code> from the boundary of the study region.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Set competitor distance</span>
<span class="va">comp_dist</span> <span class="op">&lt;-</span> <span class="fl">1</span>

<span class="co"># Add buffer variable to growth data frame</span>
<span class="va">growth_ex</span> <span class="op">&lt;-</span> <span class="va">growth_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/add_buffer_variable.html">add_buffer_variable</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">comp_dist</span>, region <span class="op">=</span> <span class="va">study_region_ex</span><span class="op">)</span>

<span class="co"># Optional: Create sf representation of buffer region</span>
<span class="va">buffer_region</span> <span class="op">&lt;-</span> <span class="va">study_region_ex</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/compute_buffer_region.html">compute_buffer_region</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">comp_dist</span><span class="op">)</span></code></pre></div>
<p>In the visualization below, the solid line represents the boundary of the study region while the dashed line delimits the buffer region within. All trees outside this buffer region (in red) will be our “focal” trees of interest in our model since we have complete competitor information on all of them. All trees inside this buffer region (in blue) will only be considered as “competitor” trees to “focal” trees.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">base_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">study_region_ex</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">buffer_region</span>, fill <span class="op">=</span> <span class="st">"transparent"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span>

<span class="va">base_plot</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">growth_ex</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">buffer</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="man/figures/README-unnamed-chunk-6-1.png" width="100%"></p>
<p>Next we add information pertaining to our spatial cross-validation scheme. We first manually define the spatial blocks that will act as our cross-validation folds and convert them to an <code>sf</code> object using the <code><a href="https://dcooley.github.io/sfheaders/reference/sf_polygon.html">sf_polygon()</a></code> function from the <code>sfheaders</code> package.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fold1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">fold2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>

<span class="va">blocks_ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://dcooley.github.io/sfheaders/reference/sf_polygon.html">sf_polygon</a></span><span class="op">(</span><span class="va">fold1</span><span class="op">)</span>,
  <span class="fu"><a href="https://dcooley.github.io/sfheaders/reference/sf_polygon.html">sf_polygon</a></span><span class="op">(</span><span class="va">fold2</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>folds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next we assign each tree to the correct folds using the <code>foldID</code> variable of the output returned by the <code><a href="https://rdrr.io/pkg/blockCV/man/spatialBlock.html">spatialBlock()</a></code> function from the <a href="https://github.com/rvalavi/blockCV"><code>blockCV</code></a> package.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">SpatialBlock_ex</span> <span class="op">&lt;-</span> <span class="fu">blockCV</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/blockCV/man/spatialBlock.html">spatialBlock</a></span><span class="op">(</span>
  speciesData <span class="op">=</span> <span class="va">growth_ex</span>, k <span class="op">=</span> <span class="fl">2</span>, selection <span class="op">=</span> <span class="st">"systematic"</span>, blocks <span class="op">=</span> <span class="va">blocks_ex</span>,
  showBlocks <span class="op">=</span> <span class="cn">FALSE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="va">growth_ex</span> <span class="op">&lt;-</span> <span class="va">growth_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>foldID <span class="op">=</span> <span class="va">SpatialBlock_ex</span><span class="op">$</span><span class="va">foldID</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>In the visualization below, the spatial blocks that act as our cross-validation folds are delineated in orange. The shape of each point indicates which fold each tree has been assigned to.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">base_plot</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">growth_ex</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">buffer</span>, shape <span class="op">=</span> <span class="va">foldID</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">blocks_ex</span>, fill <span class="op">=</span> <span class="st">"transparent"</span>, col <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span></code></pre></div>
<p><img src="man/figures/README-unnamed-chunk-9-1.png" width="100%"></p>
</div>
<div id="compute-focal-versus-competitor-tree-information" class="section level2">
<h2 class="hasAnchor">
<a href="#compute-focal-versus-competitor-tree-information" class="anchor"></a>Compute focal versus competitor tree information</h2>
<p>Based on our <code>growth</code> data frame, we now explicitly define all “focal” trees and their respective “competitor” trees in a <code>focal_vs_comp</code> data frame. This data frame has rows corresponding to each focal tree, and all information about its competitors are saved in the list-column variable <code>comp</code>. We implemented this nested format using <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> in order to minimize redundancy, given that the same tree can act as a competitor multiple times.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">focal_vs_comp_ex</span> <span class="op">&lt;-</span> <span class="va">growth_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/create_focal_vs_comp.html">create_focal_vs_comp</a></span><span class="op">(</span><span class="va">comp_dist</span>, blocks <span class="op">=</span> <span class="va">blocks_ex</span>, id <span class="op">=</span> <span class="st">"ID"</span>, comp_x_var <span class="op">=</span> <span class="st">"basal_area"</span><span class="op">)</span>
<span class="va">focal_vs_comp_ex</span>
<span class="co">#&gt; # A tibble: 6 × 7</span>
<span class="co">#&gt;   focal_ID focal_sp         dbh foldID    geometry growth comp            </span>
<span class="co">#&gt;      &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt; &lt;fct&gt;      &lt;POINT&gt;  &lt;dbl&gt; &lt;list&gt;          </span>
<span class="co">#&gt; 1        2 american_beech    20 1        (1.5 2.5)  0.800 &lt;tibble [2 × 4]&gt;</span>
<span class="co">#&gt; 2        3 sugar_maple       15 1      (1.75 2.25)  1.00  &lt;tibble [1 × 4]&gt;</span>
<span class="co">#&gt; 3        4 american_beech    12 1          (3 1.5)  0.400 &lt;tibble [1 × 4]&gt;</span>
<span class="co">#&gt; 4        5 sugar_maple       35 1      (3.25 1.75)  1.40  &lt;tibble [1 × 4]&gt;</span>
<span class="co">#&gt; 5        7 sugar_maple       22 2          (8 1.5)  0.600 &lt;tibble [3 × 4]&gt;</span>
<span class="co">#&gt; 6        9 sugar_maple       42 2       (8.75 1.5)  1.40  &lt;tibble [3 × 4]&gt;</span></code></pre></div>
<p>Using <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> we can fully expand the competitor information saved in the <code>focal_vs_comp</code> data frame. For example, the tree with <code>focal_ID</code> equal to 2 located at (1.5, 2.5) has two competitors within <code>comp_dist</code> distance from it.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">focal_vs_comp_ex</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"comp"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 11 × 10</span>
<span class="co">#&gt;    focal_ID focal_sp         dbh foldID    geometry growth comp_ID  dist</span>
<span class="co">#&gt;       &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt; &lt;fct&gt;      &lt;POINT&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1        2 american_beech    20 1        (1.5 2.5)  0.800       1 0.75 </span>
<span class="co">#&gt;  2        2 american_beech    20 1        (1.5 2.5)  0.800       3 0.354</span>
<span class="co">#&gt;  3        3 sugar_maple       15 1      (1.75 2.25)  1.00        2 0.354</span>
<span class="co">#&gt;  4        4 american_beech    12 1          (3 1.5)  0.400       5 0.354</span>
<span class="co">#&gt;  5        5 sugar_maple       35 1      (3.25 1.75)  1.40        4 0.354</span>
<span class="co">#&gt;  6        7 sugar_maple       22 2          (8 1.5)  0.600       8 0.901</span>
<span class="co">#&gt;  7        7 sugar_maple       22 2          (8 1.5)  0.600       9 0.75 </span>
<span class="co">#&gt;  8        7 sugar_maple       22 2          (8 1.5)  0.600      10 0.791</span>
<span class="co">#&gt;  9        9 sugar_maple       42 2       (8.75 1.5)  1.40        7 0.75 </span>
<span class="co">#&gt; 10        9 sugar_maple       42 2       (8.75 1.5)  1.40        8 0.791</span>
<span class="co">#&gt; 11        9 sugar_maple       42 2       (8.75 1.5)  1.40       10 0.25 </span>
<span class="co">#&gt; # … with 2 more variables: comp_sp &lt;fct&gt;, comp_x_var &lt;dbl&gt;</span></code></pre></div>
</div>
<div id="fit-model-and-make-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-model-and-make-predictions" class="anchor"></a>Fit model and make predictions</h2>
<p>We then fit our competitor growth model as specified in Allen and Kim (2020).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">comp_bayes_lm_ex</span> <span class="op">&lt;-</span> <span class="va">focal_vs_comp_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/comp_bayes_lm.html">comp_bayes_lm</a></span><span class="op">(</span>prior_param <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<p>The resulting output is an <code>comp_bayes_lm</code> object containing the posterior distribution of all linear regression parameters, the intercept, the slope for dbh for each species, and a matrix of all species pairs competitive effects on growth. The S3 object class is associated with several methods.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Print</span>
<span class="va">comp_bayes_lm_ex</span>
<span class="co">#&gt; Bayesian linear regression model parameters with a multivariate Normal</span>
<span class="co">#&gt; likelihood. See ?comp_bayes_lm for details:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   parameter_type           prior posterior</span>
<span class="co">#&gt; 1 Inverse-Gamma on sigma^2 a_0   a_star   </span>
<span class="co">#&gt; 2 Inverse-Gamma on sigma^2 b_0   b_star   </span>
<span class="co">#&gt; 3 Multivariate t on beta   mu_0  mu_star  </span>
<span class="co">#&gt; 4 Multivariate t on beta   V_0   V_star   </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model formula:</span>
<span class="co">#&gt; growth ~ sp + dbh + dbh * sp + american_beech * sp + sugar_maple * sp</span>

<span class="co"># Posterior distributions (plots combined with patchwork pkg)</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">comp_bayes_lm_ex</span>, type <span class="op">=</span> <span class="st">"intercepts"</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">comp_bayes_lm_ex</span>, type <span class="op">=</span> <span class="st">"dbh_slopes"</span><span class="op">)</span>
<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">comp_bayes_lm_ex</span>, type <span class="op">=</span> <span class="st">"competition"</span><span class="op">)</span>
<span class="op">(</span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="va">p3</span></code></pre></div>
<p><img src="man/figures/README-unnamed-chunk-13-1.png" width="100%"></p>
<p>Furthermore, we can apply a <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> method to the resulting <code>comp_bayes_lm</code> object to obtain fitted/predicted values of this model. We append these <code>growth_hat</code> values to our <code>focal_vs_comp</code> data frame.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">focal_vs_comp_ex</span> <span class="op">&lt;-</span> <span class="va">focal_vs_comp_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>growth_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">comp_bayes_lm_ex</span>, newdata <span class="op">=</span> <span class="va">focal_vs_comp_ex</span><span class="op">)</span><span class="op">)</span>
<span class="va">focal_vs_comp_ex</span>
<span class="co">#&gt; # A tibble: 6 × 8</span>
<span class="co">#&gt;   focal_ID focal_sp         dbh foldID    geometry growth comp            </span>
<span class="co">#&gt;      &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt; &lt;fct&gt;      &lt;POINT&gt;  &lt;dbl&gt; &lt;list&gt;          </span>
<span class="co">#&gt; 1        2 american_beech    20 1        (1.5 2.5)  0.800 &lt;tibble [2 × 4]&gt;</span>
<span class="co">#&gt; 2        3 sugar_maple       15 1      (1.75 2.25)  1.00  &lt;tibble [1 × 4]&gt;</span>
<span class="co">#&gt; 3        4 american_beech    12 1          (3 1.5)  0.400 &lt;tibble [1 × 4]&gt;</span>
<span class="co">#&gt; 4        5 sugar_maple       35 1      (3.25 1.75)  1.40  &lt;tibble [1 × 4]&gt;</span>
<span class="co">#&gt; 5        7 sugar_maple       22 2          (8 1.5)  0.600 &lt;tibble [3 × 4]&gt;</span>
<span class="co">#&gt; 6        9 sugar_maple       42 2       (8.75 1.5)  1.40  &lt;tibble [3 × 4]&gt;</span>
<span class="co">#&gt; # … with 1 more variable: growth_hat &lt;dbl&gt;</span></code></pre></div>
<p>We then compute the root mean squared error (RMSE) of the observed versus fitted growths as a measure of our model’s fit.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">focal_vs_comp_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://yardstick.tidymodels.org/reference/rmse.html">rmse</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">growth</span>, estimate <span class="op">=</span> <span class="va">growth_hat</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.1900981</span></code></pre></div>
</div>
<div id="run-spatial-cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#run-spatial-cross-validation" class="anchor"></a>Run spatial cross-validation</h2>
<p>Whereas in our example above we fit our model to the entirety of the data and then generate fitted/predicted growths on this same data, we now apply the same model with spatial cross-validation. All the trees in a given fold will be given a turn as the “test” data while the trees in all remaining folds will be the “training” data. We then fit the model to the training data, but compute fitted/predicted growths for the separate and independent data.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">focal_vs_comp_ex</span> <span class="op">&lt;-</span> <span class="va">focal_vs_comp_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run_cv.html">run_cv</a></span><span class="op">(</span>comp_dist <span class="op">=</span> <span class="va">comp_dist</span>, blocks <span class="op">=</span> <span class="va">blocks_ex</span><span class="op">)</span></code></pre></div>
<p>Note the increase in RMSE, reflecting the fact that our original estimate of model error was overly optimistic as it did not account for spatial autocorrelation.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">focal_vs_comp_ex</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://yardstick.tidymodels.org/reference/rmse.html">rmse</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">growth</span>, estimate <span class="op">=</span> <span class="va">growth_hat</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.4068709</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Albert Y. Kim, David Allen, Simon Couch.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
